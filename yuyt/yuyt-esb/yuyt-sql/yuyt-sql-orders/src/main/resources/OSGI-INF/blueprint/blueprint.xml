<?xml version="1.0" encoding="UTF-8"?>
<!--

    Licensed to Kingmed
-->
<blueprint
    xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:broker="http://activemq.apache.org/schema/core"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd">

    <bean id="orderBean" class="com.kingmed.yuyt.sql.OrderBean" init-method="init"/>
    <bean id="specimenBean" class="com.kingmed.yuyt.bean.SpecimenBean">
        <property name="lisClients">
            <map>
                <entry key="01.1" value-ref="testLISClient"/>
            </map>
        </property>
    </bean>
    <bean id="specimenResponseBean" class="com.kingmed.yuyt.bean.SpecimenResponseBean"/>
    <bean id="reportBean" class="com.kingmed.yuyt.bean.ReportBean">
        <property name="lisClients">
            <map>
                <entry key="01.1" value-ref="gzLISClient"/>
            </map>
        </property>
    </bean>
    <bean id="reportResponseBean" class="com.kingmed.yuyt.bean.ReportResponseBean">
        <property name="hpvHighRish17">
            <list>
                <value>人乳头瘤病毒16型</value>
                <value>人乳头瘤病毒18型</value>
                <value>人乳头瘤病毒26型</value>
                <value>人乳头瘤病毒31型</value>
                <value>人乳头瘤病毒33型</value>
                <value>人乳头瘤病毒35型</value>
                <value>人乳头瘤病毒39型</value>
                <value>人乳头瘤病毒45型</value>
                <value>人乳头瘤病毒51型</value>
                <value>人乳头瘤病毒52型</value>
                <value>人乳头瘤病毒53型</value>
                <value>人乳头瘤病毒56型</value>
                <value>人乳头瘤病毒58型</value>
                <value>人乳头瘤病毒59型</value>
                <value>人乳头瘤病毒66型</value>
                <value>人乳头瘤病毒68型</value>
                <value>人乳头瘤病毒82型</value>
            </list>
        </property>
    </bean>
    
    <bean id="myTransform" class="com.kingmed.yuyt.msg.MyTransform">
        <property name="prefix" value="${prefix}" />
    </bean>
    <bean id="lisClient" class="com.kingmed.lis.ws.client.LISClient"/>
    <reference id="yuytDataSource" interface="javax.sql.DataSource" filter="(datasource.name=yuyt)">
        <reference-listener bind-method="onBind" unbind-method="onUnbind">
            <bean class="com.kingmed.yuyt.sql.ListenerBean"/>
        </reference-listener>
    </reference>

    <bean id="sql" class="org.apache.camel.component.sql.SqlComponent">
        <property name="dataSource" ref="yuytDataSource"/>
    </bean>
    
    <cm:property-placeholder persistent-id="com.kingmed.yuyt">
        <cm:default-properties>
            <cm:property name="prefix" value="yuyt"/>
        </cm:default-properties>
    </cm:property-placeholder>
    <reference id="connectionFactory" interface="javax.jms.ConnectionFactory" />
    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="brokerURL" value="failover:(tcp://192.168.2.164:61616,tcp://192.168.2.164:61617,tcp://192.168.2.164:61618,tcp://192.168.2.164:61619)"/>
    </bean>
    <bean id="pgz" class ="com.kingmed.yuyt.model.Hospital">
        <property name="companyCode" value=""/>
        <property name="code" value=""/>
        <property name="name" value=""/>
        <property name="lisUsername" value=""/>
        <property name="lisPassword" value=""/>
    </bean>
    
    <bean id="testGZ" class ="com.kingmed.yuyt.model.Hospital">
        <property name="companyCode" value="01.1"/>
        <property name="code" value="01.10.0010"/>
        <property name="name" value="广州金域测试医院"/>
        <property name="lisUsername" value="01.10.0010"/>
        <property name="lisPassword" value="01100010"/>
    </bean>
    <bean id="testGZHA" class ="com.kingmed.yuyt.model.Hospital">
        <property name="companyCode" value="01.1"/>
        <property name="code" value="008279"/>
        <property name="name" value="广州医院A"/>
        <property name="lisUsername" value="008279"/>
        <property name="lisPassword" value="008279"/>
    </bean>
    <bean id="testGZHB" class ="com.kingmed.yuyt.model.Hospital">
        <property name="companyCode" value="01.1"/>
        <property name="code" value="008280"/>
        <property name="name" value="广州医院B"/>
        <property name="lisUsername" value="008280"/>
        <property name="lisPassword" value="008280"/>
    </bean>
    <bean id="testGZHC" class ="com.kingmed.yuyt.model.Hospital">
        <property name="companyCode" value="01.1"/>
        <property name="code" value="008281"/>
        <property name="name" value="广州医院C"/>
        <property name="lisUsername" value="008281"/>
        <property name="lisPassword" value="008281"/>
    </bean>
    <bean id = "hospitalCache" class="com.kingmed.yuyt.cache.HospitalCache">
        <property name="cache">
            <map>
                <entry key="01.1-01.10.0010" value-ref="testGZ"/>
                <entry key="01.1-008279" value-ref="testGZHA"/>
                <entry key="01.1-008280" value-ref="testGZHB"/>
                <entry key="01.1-008281" value-ref="testGZHC"/>
            </map>
        </property>
    </bean>
    <bean id = "phospitalCache" class="com.kingmed.yuyt.cache.HospitalCache">
        <property name="cache">
            <map>
                <entry key="01.1-01.12.0054" value-ref="pgz"/>
            </map>
        </property>
    </bean>
    
    <bean id="testLISClient" class="com.kingmed.lis.ws.client.LISClient" init-method="init">
        <property name="companyCode" value="01.1"/>
        <property name="companyName" value="广州金域医学检验中心"/>
        <property name="ilisPortAddress" value="http://192.168.4.46:60080/GZWSTEST/Lis.dll/soap/ilis"/>
        <property name="hospitalCache" ref="hospitalCache"/>
    </bean>
    
    <bean id="gzLISClient" class="com.kingmed.lis.ws.client.LISClient" init-method="init">
        <property name="companyCode" value="01.1"/>
        <property name="companyName" value="广州金域医学检验中心"/>
        <property name="ilisPortAddress" value="http://192.168.4.46:60080/GZWS/Lis.dll/soap/ilis"/>
        <property name="hospitalCache" ref="phospitalCache"/>
    </bean>
    
    <camelContext xmlns="http://camel.apache.org/schema/blueprint">
        
        <propertyPlaceholder id="placeholder" location="classpath:sql.properties"/>
        <!-- 转换标本信息 -->
        <route id="uploadSpec1-route">
            <from uri="sql:{{sql.selectSpecRcved}}?consumer.onConsume={{sql.markSpec}}"/>
            <to uri="bean:specimenBean?method=convertSpecimen"/>
            <to uri="sql:{{sql.insertLog}}"/>
            <log message="已经转换标本信息 ${body[id]}"/>
        </route>
        <!-- 上传标本信息 写入到消息队列 -->
        <route id="uploadSpec2-route">
            <from uri="sql:{{sql.selectMsg}}?consumer.onConsume={{sql.markSpecOut}}"/>
            <setBody>
                <simple>${body[msg]}</simple>
            </setBody>
            <to uri="activemq:queue:q_test" />
            <log message="已经上传标本信息到MQ ${body}"/>
        </route>
        
        <!-- 上传标本信息，从消息队列写入到LIS中 -->
        <route id="uploadSpec3-route">
            <from uri="activemq:queue:q_test" />
            <to uri="bean:specimenBean" />
            <to uri="activemq:queue:q_test_res" />
        </route>
        
        <!-- 上传标本信息，将返回信息从消息队列写入到域医通数据库中 -->
        <route id="uploadSpec4-route">
            <from uri="activemq:queue:q_test_res" />
            <to uri="bean:specimenResponseBean" />
            <log message="标本信息已经上传到LIS，${body}"/>
            <to uri="sql:{{sql.markSpecPlaced}}" />
            <log message="已经更新消息的状态，已经上传消息到LIS,${body}"/>
            <to uri="sql:{{sql.markSpecTesting}}" />
            <log message="已经更新标本的状态，检测中,${body}"/>
            <to uri="sql:{{sql.markSpecReporting}}" />
            <log message="已经更新报告单，可查询报告单,${body}"/>
        </route>
       
        <!-- 查询报告单，组装报文 -->
        <route id="queryReport1-route">
            <from uri="sql:{{sql.selectQueryReport}}"/>
            <to uri="bean:reportBean?method=convertReport"/>
            <to uri="sql:{{sql.insertLog}}"/>
            <log message="已经转换查询报告单的报文信息 ${body[id]}"/>
        </route>
        <!-- 查询报告单，从域医通数据库写入到消息队列 -->
        <route id="queryReport2-route">
            <from uri="sql:{{sql.selectMsgQR}}?consumer.onConsume={{sql.markMsgQROut}}"/>
            <setBody>
                <simple>${body[msg]}</simple>
            </setBody>
            <to uri="activemq:queue:q_qr_req" />
            <log message="查询报告单报文已经到MQ ${body}"/>
        </route>
        <!-- 查询报告单，从LIS写入到消息队列 -->
        <route id="queryReport3-route">
            <from uri="activemq:queue:q_qr_req" />
            <to uri="bean:reportBean" />
            <to uri="activemq:queue:q_qr_res" />
        </route>
        <!-- 查询报告单，将返回信息从消息队列写入到域医通数据库中 -->
        <route id="queryReport4-route">
            <from uri="activemq:queue:q_qr_res" />
            <to uri="bean:reportResponseBean" />
            <log message="报告单已经上传到LIS，${body[docid]}"/>
            <choice>
                <when>
                    <simple>${body[isReimbu]} != null</simple>
                    <log message="实验室退单"/>
                </when>
                <when>
                    <simple>${body[lis_status]} == '0' </simple>
                    <log message="报告单不为空，将报告单内容插入日志"/>
                    <to uri="sql:{{sql.insertLog}}"/>
                </when>
            </choice>
        </route>
        
    </camelContext>
</blueprint>